# Makefile
.PHONY: all setup run lint fmt test docker-build docker-run clean

# Virtual-env location and stamp file
VENV         := .venv
STAMP        := $(VENV)/.setup_complete
PYTHON       := $(VENV)/bin/python
PIP          := $(VENV)/bin/pip

# Default to setting up the environment
all: setup

# Recreate venv and reinstall if requirements.txt changes
$(STAMP): requirements.txt
	@echo "ğŸ”§ Creating/updating virtual environment in $(VENV)â€¦"
	@python3.11 -m venv $(VENV)
	@$(PIP) install --upgrade pip
	@$(PIP) install --no-cache-dir -r requirements.txt
	@touch $(STAMP)
	@echo "âœ… Virtual environment is ready."

# Alias for the venv setup
setup: $(STAMP)

# Run your Watsonx Agent (stdio MCP server)
run: setup
	@echo "ğŸš€ Starting Watsonx Agent (stdio)â€¦"
	@$(PYTHON) server.py

# Lint with flake8
lint: setup
	@echo "ğŸ” Running flake8â€¦"
	@$(VENV)/bin/flake8 .

# Format with Black
fmt: setup
	@echo "ğŸ¨ Formatting with blackâ€¦"
	@$(VENV)/bin/black .

# Run tests
test: setup
	@echo "ğŸ§ª Running pytestâ€¦"
	@$(VENV)/bin/pytest -q

# Build the Docker image
docker-build:
	@echo "ğŸ³ Building Docker image watsonx-agent:latestâ€¦"
	@docker build -t watsonx-agent:latest .

# Run the Docker container (stdin/stdout)
docker-run:
	@echo "ğŸ³ Running Docker containerâ€¦"
	@docker run --rm -it \
		--env-file .env \
		--name watsonx-agent \
		watsonx-agent:latest

# Clean out the virtual environment
clean:
	@echo "ğŸ§¹ Removing virtual environmentâ€¦"
	@rm -rf $(VENV)
